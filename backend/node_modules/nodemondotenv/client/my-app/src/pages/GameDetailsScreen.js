import React, { useEffect, useState } from 'react';
import { Container, Row, Col, Card, Button } from 'react-bootstrap';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';
import { useCart } from '../components/CartContext';

function GameDetailsScreen() {
  const { id } = useParams();
  const [game, setGame] = useState(null);
  const { addToCart, cartItems } = useCart();
  const navigate = useNavigate();

  useEffect(() => {
    const fetchGame = async () => {
      try {
        const response = await axios.get(`http://localhost:3000/api/game/games/${id}`);
        setGame(response.data);
      } catch (error) {
        console.error('Ошибка при получении данных:', error);
      }
    };

    fetchGame();
  }, [id]);

  const handleAddToCart = () => {
    const existingItem = cartItems.find((item) => item.id === game.id);
    const totalQuantity = (existingItem ? existingItem.quantity : 0) + 1;

    if (totalQuantity <= game.inStock) {
      addToCart(game);
      navigate('/cart')
    } else {
      alert('Невозможно добавить больше товаров, чем есть в наличии.');
    }
  };

  if (!game) {
    return <div>Loading...</div>;
  }

  const systemRequirementsList = game.systemRequirements ? game.systemRequirements.split(',').map((req, index) => (
    <li key={index}>{req.trim()}</li>
  )) : null;

  return (
    <Container className="min-vh-100 py-4 mt-4" style={{borderRadius:'10px', backgroundColor: '#272727', color: '#272727'}}>
      <Row>
        <Col md={12} className="text-center">
          <Card.Title style={{color: '#fff', fontSize: '40px'}}>{game.name}</Card.Title>
        </Col>
      </Row>
      <Row className="justify-content-center">
        <Col md={6} className="text-center">
          <Card.Img
            variant="top"
            src={`http://localhost:3000/uploads/${game.img}`}
            alt={game.name}
            style={{ height: '50vh', objectFit: 'cover'}}
            className='mt-2'
          />
        </Col>
      </Row>
      <Row className="justify-content-center mt-4">
        <Col md={6}>
          <Card.Text style={{color: '#fff'}}>
            Цена: {game.price}р.
          </Card.Text>
          <Card.Text style={{color: '#fff'}}>
            Год выпуска: {game.year}
          </Card.Text>
          <Card.Text style={{color: '#fff'}}>
            В наличии: {game.inStock}
          </Card.Text>
          <Card.Text style={{color: '#fff'}}>
            Системные требования:
            <ul>
              {systemRequirementsList}
            </ul>
          </Card.Text>
          <Button variant="success" className="w-100" onClick={handleAddToCart}>
            В корзину
          </Button>
        </Col>
      </Row>
    </Container>
  );
}

export default GameDetailsScreen;
